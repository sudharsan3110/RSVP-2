name: Check prettier, linting, build and linked issue

on:
  workflow_dispatch:
  pull_request:
    types: [opened, ready_for_review, synchronize]
    branches:
      - stage
      - prod

jobs:
  standards:
    if: github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    environment: ${{ github.base_ref == 'stage' && 'STAGE' || 'PROD' }}
    permissions:
      issues: read
      pull-requests: write
    env:
      DATABASE_URL: "mysql://root:password@127.0.0.1/database_name"
      ACCESS_TOKEN_SECRET: "test-access-secret"
      REFRESH_TOKEN_SECRET: "test-refresh-secret"
      CLIENT_URL: "http://localhost:3000"
      EMAIL_TOKEN: "test-email-token"
      EMAIL_API_URL: "http://localhost/email"
      AWS_ACCESS_KEY: "test-aws-access"
      AWS_SECRET_KEY: "test-aws-secret"
      AWS_REGION: "us-east-1"
      AWS_BUCKET_NAME: "test-bucket"
      GOOGLE_CLIENT_ID: "google-client-id"
      GOOGLE_CLIENT_SECRET: "google-client-secret"
      GOOGLE_REDIRECT_URI: "http://localhost/google"
      MAX_INVITES: "20"
    steps:
      - name: Checkout repository content
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Check for folder changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            web:
              - 'apps/web/**'
            server:
              - 'apps/server/**'

      - name: Install workspace dependencies
        if: steps.filter.outputs.web == 'true' || steps.filter.outputs.server == 'true'
        run: pnpm install

      - name: Frontend Linting Check
        if: steps.filter.outputs.web == 'true'
        run: pnpm --filter web lint

      - name: Backend Linting Check
        if: steps.filter.outputs.server == 'true'
        run: pnpm --filter server lint

      - name: Frontend Prettier Check
        if: steps.filter.outputs.web == 'true'
        run: pnpm --filter web check

      - name: Backend Prettier Check
        if: steps.filter.outputs.server == 'true'
        run: pnpm --filter server check

      - name: Frontend Build Check
        if: steps.filter.outputs.web == 'true'
        run: pnpm --filter web build

      - name: Backend Build Check
        if: steps.filter.outputs.server == 'true'
        run: pnpm --filter server build

      - name: Backend Generate Prisma Client
        if: steps.filter.outputs.server == 'true'
        run: 
          pnpm --filter server generate

      - name: Backend Test Cases Check
        if: steps.filter.outputs.server == 'true'
        run: 
          pnpm --filter server test

      - name: Frontend Test Cases Check
        if: steps.filter.outputs.web == 'true'
        run: pnpm --filter web test

      - name: Check linked issues
        if: always()
        id: linked-issues
        uses: nearform-actions/github-action-check-linked-issues@v1
        with:
          exclude-branches: "release/**, dependabot/**"

      - name: Transfer Labels from Linked Issues
        if: always() && steps.linked-issues.outcome == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            const linkedIssuesJson = '${{ steps.linked-issues.outputs.issues }}';
            const linkedIssuesRaw = JSON.parse(linkedIssuesJson);
            const linkedIssues = linkedIssuesRaw.map(issueRef => {
                const parts = issueRef.split('#');
                return parseInt(parts[parts.length - 1]);
              }).filter(num => !isNaN(num));
            const allLabels = new Set();
            for (const issueNumber of linkedIssues) {
              const linkedIssue = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });
              linkedIssue.data.labels.forEach(label => {
                allLabels.add(label.name);
              });
            }
            if (allLabels.size === 0) {
              return;
            }
            const labelsArray = Array.from(allLabels);
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: labelsArray
            });

      - name: Assign PR to Author
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const assignee = context.payload.pull_request.user.login;
            const { data: pullRequest } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: issue_number
            });
            if (pullRequest.assignees.length === 0) {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number,
                  assignees: [assignee]
                });
            }
